<!doctype html>
<html>
	<head>
		<title>gyromidi controller</title>
		<style>
			* {
				font-family: sans-serif;
			}
		</style>
	</head>
	<body>
		<h1>gyromidi controller</h1>
		<hr>
		<span>Enter polling rate (hz):</span>
		<input type="number" id="polling_rate"></input>
		<hr>
		<button onclick="startPolling()">Start Polling</button>
		<button onclick="stopPolling()">Stop Polling</button>
		<hr>
		<h1 style="writing-mode: vertical-rl;">THIS WAY UP</h1>

		<script>
			var curAngleAlpha = 0;
			var curAngleBeta = 0;
			var curAngleGamma = 0;

			var polling = false;
			var requestedGyro = false;

			async function startPolling() {
				if (!requestedGyro) {
					requestedGyro = true;
					if (typeof DeviceMotionEvent.requestPermission === 'function') {
        					await DeviceMotionEvent.requestPermission()
        					.catch((err) => {
							alert(`Error getting sensor permission: ${err}`);
            						return;
        					})
    					}
                			window.addEventListener("deviceorientation", (event) => {
						curAngleAlpha = event.alpha;
						curAngleBeta = event.beta;
						curAngleGamma = event.gamma;
                			})
				}
				polling = true;
				doPoll();
			}

			function stopPolling() {
				polling = false;
			}
			
			var polling_rate_hz = 1;

			document.getElementById("polling_rate").addEventListener("change", (event) => {
				polling_rate_hz = parseFloat(event.target.value);
			});

			function doPoll() {
				sendRequest(curAngleAlpha, curAngleBeta, curAngleGamma);
				if (polling) {
					setTimeout(doPoll, (1/polling_rate_hz)*1000)
				}
			}
			
			function sendRequest(x, y, z) {
				fetch(window.location.origin + "/action", {
  					method: "POST",
  					body: JSON.stringify(
						{
							"AngleX": x,
							"AngleY": y,
							"AngleZ": z
						}
					),
  					headers: {
						"Content-type": "application/json; charset=UTF-8"
  					}
				});
			}
		</script>
	</body>
</html>
